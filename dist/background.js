chrome.runtime.onInstalled.addListener(()=>{console.log("Calendar TODO Extension installed"),chrome.notifications.getPermissionLevel(e=>{e!=="granted"&&console.log("Notification permission not granted")}),chrome.storage.local.get(["tasks","categories","settings"],e=>{if(e.tasks||chrome.storage.local.set({tasks:[]}),!e.categories){const s=[{id:"1",name:"仕事",color:"#4285F4",isDefault:!0},{id:"2",name:"プライベート",color:"#34A853",isDefault:!0},{id:"3",name:"買い物",color:"#FBBC04",isDefault:!0},{id:"4",name:"勉強",color:"#EA4335",isDefault:!0},{id:"5",name:"健康",color:"#34A853",isDefault:!0},{id:"6",name:"その他",color:"#9E9E9E",isDefault:!0}];chrome.storage.local.set({categories:s})}if(!e.settings){const s={theme:"system",notifications:{enabled:!0,sound:!0,dailySummary:!0,weeklyReview:!1},sync:{enabled:!0}};chrome.storage.local.set({settings:s})}})});chrome.alarms.onAlarm.addListener(e=>{if(console.log("Alarm fired:",e.name),e.name.startsWith("task-reminder-")){const s=e.name.replace("task-reminder-","");c(s)}else e.name==="daily-summary"?l():e.name==="weekly-review"&&m()});async function c(e){const t=((await chrome.storage.local.get("tasks")).tasks||[]).find(a=>a.id===e);t&&!t.completed&&chrome.notifications.create(`task-${e}`,{type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"タスクリマインダー",message:t.title,priority:t.priority==="high"?2:1,buttons:[{title:"完了にする"},{title:"スヌーズ (15分後)"}]})}async function l(){const s=(await chrome.storage.local.get("tasks")).tasks||[],o=new Date;o.setHours(0,0,0,0);const t=new Date(o);t.setDate(t.getDate()+1);const a=s.filter(i=>{const n=new Date(i.dueDate);return n>=o&&n<t&&!i.completed});a.length>0&&chrome.notifications.create("daily-summary",{type:"list",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"今日のタスク",message:`${a.length}件のタスクがあります`,items:a.slice(0,5).map(i=>({title:i.title,message:i.description||""}))})}async function m(){const s=(await chrome.storage.local.get("tasks")).tasks||[],o=new Date,t=new Date(o);t.setDate(t.getDate()-7);const a=s.filter(n=>{const r=new Date(n.updatedAt);return n.completed&&r>=t}),i=s.filter(n=>!n.completed);chrome.notifications.create("weekly-review",{type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"週次レビュー",message:`今週は${a.length}件のタスクを完了しました。残り${i.length}件のタスクがあります。`,priority:0})}chrome.notifications.onButtonClicked.addListener((e,s)=>{if(e.startsWith("task-")){const o=e.replace("task-","");s===0?d(o):s===1&&chrome.alarms.create(`task-reminder-${o}`,{delayInMinutes:15}),chrome.notifications.clear(e)}});async function d(e){const o=(await chrome.storage.local.get("tasks")).tasks||[],t=o.findIndex(a=>a.id===e);t!==-1&&(o[t].completed=!0,o[t].updatedAt=new Date().toISOString(),await chrome.storage.local.set({tasks:o}))}chrome.storage.onChanged.addListener((e,s)=>{s==="local"&&e.tasks&&u(e.tasks.newValue),s==="local"&&e.settings&&g(e.settings.newValue)});async function u(e){var o;const s=await chrome.alarms.getAll();for(const t of s)t.name.startsWith("task-reminder-")&&chrome.alarms.clear(t.name);for(const t of e)if((o=t.reminder)!=null&&o.enabled&&!t.completed){const a=new Date(t.reminder.time);a>new Date&&chrome.alarms.create(`task-reminder-${t.id}`,{when:a.getTime()})}}function g(e){var s,o;if((s=e.notifications)!=null&&s.dailySummary){const t=new Date,a=new Date(t);a.setDate(a.getDate()+1),a.setHours(9,0,0,0),chrome.alarms.create("daily-summary",{when:a.getTime(),periodInMinutes:24*60})}else chrome.alarms.clear("daily-summary");if((o=e.notifications)!=null&&o.weeklyReview){const t=new Date,a=new Date(t),n=(8-a.getDay())%7;a.setDate(a.getDate()+n),a.setHours(9,0,0,0),chrome.alarms.create("weekly-review",{when:a.getTime(),periodInMinutes:7*24*60})}else chrome.alarms.clear("weekly-review")}
